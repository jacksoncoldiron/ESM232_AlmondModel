---
title: "Almond Yield Anomalies"
author: "Jackson Coldiron and Kaitlin Castor"
editor: visual
format: 
  html:
    code-fold: true
    embed-resources: true
    theme: lumen
    toc: true
execute:
  freeze: auto 
  warning: false
  message: false
---

## Introduction

This assignment builds on our almond yield anomaly model by incorporating an economic dimension—profit. Using yield anomalies calculated from climate data, we developed a profit model that estimates annual almond profits based on variable production costs and market prices. We then performed a simple sensitivity analysis to explore how uncertainty in key parameters—specifically cost per acre and price per ton—affects estimated profit across years. This analysis allows us to assess the robustness of almond profitability under different economic scenarios and visualize how sensitive outcomes are to these inputs.

## Data

#### Data Description

The climate dataset (clim.txt) contains daily weather observations including:

day: Day of the month

month: Calendar month

year: Calendar year

wy: Water year

tmax_c: Daily maximum temperature (°C)

tmin_c: Daily minimum temperature (°C)

precip: Daily precipitation (mm)

Other parameters: - location: California - time frame: 1989-2010 - yield model adjusted R\*\*2 = 0.88 - yield model developed from monthly averages aggregated to the state scale from 1980 - 2003 records. This excludes factors such as extreme heat events or spatial variations.

These inputs are used to compute annual almond yield anomalies. The expected outputs include the maximum, minimum, and mean yield anomalies across all years in the dataset. According to the assignment benchmark, the modeled yield anomalies should approximately range between –0.027 to 1920 tons/acre, with a mean around 182 tons/acre.

#### Data Processing

```{r}
# Import libraries
library(tidyverse)
library(here)
library(dplyr)
library(purrr)
library(tibble)
library(knitr)
library(kableExtra)
library(ggpubr)

# Define baseline yield
baseline <- 5

# Import data and function
climate_data_raw <- read.table(here("data", "clim.txt"), header = TRUE, sep = "", quote = "\"")

source(here("R", "almond_yield_function.R"))
source(here("R", "almond_profit_function.R"))
source(here("R", "almond_yield_uncertainty_function.R"))

# Summarize inputs by year for model
yearly_anomalies <- climate_data_raw |>
  group_by(year) |>
  summarise(
    Tn = mean(tmin_c[month == 2], na.rm = TRUE),
    P = sum(precip[month == 1], na.rm = TRUE)) |>
    drop_na() |>
  mutate(yield_anomaly = almond_yield(Tn, P))

```

## Almond Profit

```{r}
# Bring in the wrapper function
source(here("R", "almond_wrapper_function.R"))

# Apply wrapper function on each year
yearly_profits <- yearly_anomalies |>
  mutate(
    profit = pmap_dbl(
      list(Tn, P),
      function(Tn, P) almond_profit_wrapper(Tn, P)
    )
  )
```

## Sensitivity Analysis

#### Almond Yield Sensitivity

```{r}
# generate samples for temperature coefficient
nsamples <- 300

Tc <- rnorm(mean = 0.0046, sd = 0.1, n = nsamples)
Pc <- rnorm(mean = 0.0043, sd = 0.1, n = nsamples)

coeff_parms <- cbind.data.frame(Tc, Pc)

# create dataframe with all combinations of parameters

coeff_sensitivity_df <- crossing(
  yearly_anomalies,
  coeff_parms
)

# run the yield anomaly function across the new dataframe
sensitivity_yield <- coeff_sensitivity_df |>
  mutate(
    new_yield = pmap_dbl(
      list(Tc, Pc, Tn, P),
      function(Tc, Pc, Tn, P) almond_yield_uncertainty(
          Tc = Tc,
          Pc = Pc,
          Tn = Tn,
          P = P
        )
    )
  )

```

#### Cost per ton Sensitivity

```{r}
# generate samples for both parameters
nsamples <- 300
deviation <- 0.15
base_cost <- 15000

set.seed(42)  # for reproducibility

costs_per_acre <- runif(
  min = base_cost - deviation * base_cost,
  max = base_cost + deviation * base_cost, n = nsamples
)

price_per_ton <- rnorm(mean = 4000, sd = 0.1, n = nsamples)

parms <- cbind.data.frame(costs_per_acre, price_per_ton)

# create dataframe with all combinations of parameters
sensitivity_df <- crossing(
  yearly_anomalies,
  parms
)

# run the profit function across the new dataframe
sensitivity_profit_df <- sensitivity_df |>
  mutate(
    profit = pmap_dbl(
      list(
        price_per_ton = price_per_ton,
        costs_per_acre = costs_per_acre,
        yield_anomaly = yield_anomaly
      ),
      function(price_per_ton, costs_per_acre, yield_anomaly) {
        almond_profit(
          price_per_ton = price_per_ton,
          costs_per_acre = costs_per_acre,
          baseline_yield = 1.25,
          yield_anomaly = yield_anomaly
        )
      }
    )
  )

```

#### Figure 1: Overall Variation of Yield Anomaly

```{r}
# create graph with both uncertainties
a <- ggplot(data = sensitivity_yield, aes(Tc, new_yield, col = Pc)) + 
  geom_point() + 
  labs(
    x = "Temperature Coefficient",
    y = "Almond yield (ton / acre)"
  ) +
  theme_classic()

# create graph switching visualization of uncertainties
b <- ggplot(data = sensitivity_yield, aes(Pc, new_yield, col = Tc)) + 
  geom_point() + 
  labs(
    x = "Precipitation Coefficient",
    y = "Almond yield (ton / acre)"
  ) +
  theme_classic()

#combine graphs
sensitivity_yield_plot <- ggarrange(a, b)
sensitivity_yield_plot
```

#### Figure 2: Comparison of parameters sensitivity on profit

```{r}
#| label: fig-profit
#| fig-cap: __Almond profits Variation with Uncertainty in Price and Cost__. The graph on the left shows the variation in profit for each year, with uncertainty in price per ton and cost per acre. Because of the large variety in profit across years and major outliers in 1995, 2005 and 2008 the individual box plots for each year, however, are difficult to make out. So, the graph on the right shows just the variation in profit for 2010. 

sensitivity_profit_lastyear <- sensitivity_profit_df |>
  filter(year == 2010)

year_levels <- levels(factor(sensitivity_profit_df$year))
every_fifth_year <- year_levels[as.numeric(year_levels) %% 5 == 0]

profit_time_box <- ggplot(sensitivity_profit_df, aes(x = factor(year), y = profit)) +
  geom_boxplot(fill = "#4682B4", alpha = 0.7, outlier.alpha = 0.2) +
  labs(x = "", y = "") +
  scale_x_discrete(breaks = every_fifth_year) +
  theme_classic()

profit_time_lastyear <- ggplot(sensitivity_profit_lastyear, aes(x = factor(year), y = profit)) +
  labs(x = "", y = "") +
  geom_boxplot(fill = "#4682B4", alpha = 0.7, outlier.alpha = 0.2) +
   scale_y_continuous(position = "left") +
  theme_classic()

library(ggpubr)
combined_box <- ggarrange(profit_time_box, profit_time_lastyear)

annotate_figure(
  combined_box,
  left = text_grob("Profit ($/acre)", rot = 90, size = 12),
  bottom = text_grob("Year", size = 12)
)

```

## Discussion
